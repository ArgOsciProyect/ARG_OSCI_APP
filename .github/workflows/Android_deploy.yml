name: Android Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [created]

jobs:
  build-android:
    name: ğŸ“± Build Android App
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ¯ Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.4'
          channel: 'stable'

      - name: ğŸ“¥ Get dependencies
        run: flutter pub get

      - name: ğŸ”§ Fix Java home in Gradle
        run: |
          # Create or update gradle.properties to use the correct Java home
          mkdir -p ~/.gradle
          echo "org.gradle.java.home=$JAVA_HOME" > ~/.gradle/gradle.properties
          
          # Display Java and Flutter info for debugging
          echo "Using JAVA_HOME: $JAVA_HOME"
          java -version
          flutter --version
        
      - name: ğŸ”§ Setup Android SDK
        run: flutter config --android-sdk $ANDROID_SDK_ROOT
      
      - name: ğŸ¯ Setup Flutter icons
        run: |
          # Add flutter_launcher_icons package
          flutter pub add --dev flutter_launcher_icons
          
          # Create config file for flutter_launcher_icons
          cat > flutter_launcher_icons.yaml << EOF
          flutter_launcher_icons:
            android: true
            ios: false
            image_path: "lib/assets/icons/ARG_OSCI_ICON.png"
            adaptive_icon_background: "#121212" # Dark background for the icon
            adaptive_icon_foreground: "lib/assets/icons/ARG_OSCI_ICON.png"
          EOF
          
          # Generate icons
          flutter pub run flutter_launcher_icons
      
      - name: ğŸ”§ Update Android Manifest
        run: |
          # Add tools namespace and replace attribute to main AndroidManifest.xml
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            # Add tools namespace if not present
            sed -i '/<manifest/s/xmlns:android="[^"]*"/& xmlns:tools="http:\/\/schemas.android.com\/tools"/' android/app/src/main/AndroidManifest.xml
            
            # Add tools:replace to application tag
            sed -i '/<application/s/android:label="[^"]*"/android:label="ARG OSCI" tools:replace="android:label"/' android/app/src/main/AndroidManifest.xml
          fi
          
          # Update debug AndroidManifest.xml if it exists
          if [ -f "android/app/src/debug/AndroidManifest.xml" ]; then
            # Remove android:label from debug manifest to avoid conflicts
            sed -i '/<application/s/android:label="[^"]*"//' android/app/src/debug/AndroidManifest.xml
          fi
      
          # Verify changes
          echo "Main AndroidManifest.xml:"
          cat android/app/src/main/AndroidManifest.xml
          echo "Debug AndroidManifest.xml:"
          cat android/app/src/debug/AndroidManifest.xml || echo "Debug manifest not found"
      
      - name: ğŸ”§ Build debug APK (initial)
        run: |
          # Add --no-tree-shake-icons to avoid potential issues
          flutter build apk --debug --no-tree-shake-icons || echo "Initial build expected to fail, continuing..."         
          # Make sure gradlew is executable if it exists
          if [ -f "android/gradlew" ]; then
            chmod +x android/gradlew
          fi
      
      - name: ğŸ”‘ Setup Keystore
        if: github.event_name == 'release'
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "HAS_KEYSTORE=true" >> $GITHUB_ENV
            mkdir -p android/app
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore.jks
            cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=keystore.jks
          EOF
          else
            echo "HAS_KEYSTORE=false" >> $GITHUB_ENV
          fi

      - name: ğŸ“± Build Debug APK
        if: github.event_name != 'release' || env.HAS_KEYSTORE != 'true'
        run: flutter build apk --debug --no-tree-shake-icons

      - name: ğŸ“± Build Release APK
        if: github.event_name == 'release' && env.HAS_KEYSTORE == 'true'
        run: flutter build apk --release --no-tree-shake-icons

      - name: ğŸ“± Build App Bundle
        if: github.event_name == 'release' && env.HAS_KEYSTORE == 'true'
        run: flutter build appbundle --release

      - name: ğŸ“¤ Upload Debug APK
        if: github.event_name != 'release' || env.HAS_KEYSTORE != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: build/app/outputs/flutter-apk/app-debug.apk

      - name: ğŸ“¤ Upload Release Artifacts
        if: github.event_name == 'release' && env.HAS_KEYSTORE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          # Changed upload path to root
          if-no-files-found: error

  create-release:
    name: ğŸ“¦ Create Release
    needs: build-android
    # Stricter condition to ensure this only runs for actual releases
    if: github.event_name == 'release' && github.event.action == 'created'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Download debug artifact
        if: github.event_name == 'release' && env.HAS_KEYSTORE != 'true'
        uses: actions/download-artifact@v4
        with:
          name: debug-apk
          path: release-artifacts
          
      - name: ğŸ“¥ Download release artifact
        if: github.event_name == 'release' && env.HAS_KEYSTORE == 'true'
        uses: actions/download-artifact@v4
        with:
          name: android-release
          path: release-artifacts
      
      - name: ğŸ“ List downloaded files
        shell: bash
        run: |
          echo "Current directory content:"
          ls -la
          echo "Downloaded files in release-artifacts:"
          ls -la release-artifacts || echo "No files found"
      
      - name: ğŸš€ Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-artifacts/*.apk
            release-artifacts/*.aab
          fail_on_unmatched_files: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}