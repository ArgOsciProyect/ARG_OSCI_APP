---
config:
    layout: elk
    rankdir: LR
---
flowchart LR
    subgraph Acquisition["Data Acquisition"]
        direction TB
        Device([ESP32 Device]) --> Socket[SocketService]
        Device -.->|"Hardware config\nSampling capabilities"| DeviceConfig[DeviceConfigProvider]
        Socket -->|Binary data| Process[DataAcquisitionService]
        
        %% Configuration affecting acquisition
        DeviceConfig -.->|"Sampling frequency\nVoltage scales\nBit masks"| Process
        
        %% Trigger configuration affects acquisition behavior
        TriggerConfig[TriggerData] -.->|"Level, Edge, Mode\nHysteresis"| Process
    end
    
    subgraph Processing["Signal Processing"]
        direction TB
        Process -->|Raw samples| DataProvider[DataAcquisitionProvider]
        
        %% Filter system in the correct place
        FilterSystem[FilterTypes] -.->|"Filter algorithms"| DataProvider
        DataProvider -->|"_applyFilter()"| ProcessedData[(Processed Data)]
        
        %% Branch into two processing paths
        ProcessedData --> OscilloPath
        ProcessedData --> FFTPath
        
        %% Filtering affects both paths
        DeviceConfig -.->|"Sampling frequency\nfor filter parameters"| FilterSystem
    end
    
    subgraph Analysis["Signal Analysis"]
        direction TB
        OscilloPath -->|Time-domain data| OscilloService[OscilloscopeChartService]
        FFTPath -->|Time-domain data| FFTService[FFTChartService]
        
        %% Signal parameter extraction - corrected responsibilities
        OscilloService -->|"Processed time-domain signal\nTrigger display handling"| OscilloProvider[OscilloscopeChartProvider]
        FFTService -->|"FFT computation\nFrequency detection\nSpectrum analysis"| FFTProvider[FFTChartProvider]
        
        %% Analysis depends on current configuration
        DeviceConfig -.->|"Sampling rate\nTime base calculations"| OscilloService
        DeviceConfig -.->|"Sampling rate\nFFT window size"| FFTService
    end
    
    subgraph Visualization["Visualization"]
        direction TB
        GraphScreen[GraphScreen] --> ChartArea
        
        %% Mode switching
        UserSettingsProvider -->|Mode selection| GraphScreen
        
        %% Chart container with simplified structure
        ChartArea -->|Current mode| ActiveChart{Active Chart}
        ActiveChart -->|"mode==Oscilloscope"| OscilloChart[OscilloscopeChart]
        ActiveChart -->|"mode==Spectrum"| FFTChart[FFTChart]
        
        %% Final display
        OscilloChart --> Screen([User Display])
        FFTChart --> Screen
    end
    
    %% Provider data flow to charts
    OscilloProvider -->|"Time-scale\nValue-scale\nOffset"| OscilloChart
    FFTProvider -->|"Frequency-scale\nMagnitude-scale"| FFTChart
    
    %% Explicit bidirectional control flow
    DataProvider <-.->|Status, Commands| Process
    
    %% User interaction with bidirectional controls where applicable - SIMPLIFIED
    UserControls([User Controls]) -.->|"Filter selection\nParameter config"| FilterSystem
    UserControls -.->|"Trigger settings"| TriggerConfig
    UserControls <-.->|"Timebase, Voltage scale\nSampling frequency"| DeviceConfig
    UserControls -.->|"Mode selection"| UserSettingsProvider
    
    %% Direct user interaction with providers - SIMPLIFIED
    UserControls <-.->|"Zoom, Pan\nAutoset\nPause/Resume"| OscilloProvider
    UserControls <-.->|"Zoom, Pan\nAutoset\nPause/Resume"| FFTProvider
    
    %% Return paths for user feedback
    Process -->|"Connection status\nError codes"| UserControls
    
    %% Style definitions
    classDef hardware fill:#f96,stroke:#333,stroke-width:2px
    classDef service fill:#bfb,stroke:#333,stroke-width:1px
    classDef provider fill:#fbf,stroke:#333,stroke-width:1px
    classDef ui fill:#9ee,stroke:#333,stroke-width:1px
    classDef data fill:#feb,stroke:#333,stroke-width:1px
    classDef output fill:#f96,stroke:#333,stroke-width:3px
    
    %% Apply classes
    class Device,UserControls hardware
    class Screen output
    class Socket,Process,OscilloService,FFTService service
    class DataProvider,OscilloProvider,FFTProvider,UserSettingsProvider provider
    class OscilloChart,FFTChart,GraphScreen,ChartArea ui
    class DeviceConfig,FilterSystem,TriggerConfig,ProcessedData data
    
    %% Style the subgraphs
    style Acquisition fill:#f5f5f5,stroke:#777,stroke-width:2px
    style Processing fill:#f0f8ff,stroke:#777,stroke-width:2px
    style Analysis fill:#f5f0ff,stroke:#777,stroke-width:2px
    style Visualization fill:#f0fff0,stroke:#777,stroke-width:2px